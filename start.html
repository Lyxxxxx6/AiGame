<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>失控赛车：不刹车</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{width:100%;height:100%;overflow:hidden;background:#05060c;font-family:"Inter","PingFang SC",system-ui;}
body{color:#eaf5ff;}
#canvas{width:100%;height:100%;background:radial-gradient(ellipse at center,#0a0f1d 0%,#05060c 55%,#010104 100%);}#hud{position:fixed;top:10px;left:50%;transform:translateX(-50%);display:flex;gap:10px;z-index:10;}.hud-item{min-width:100px;padding:6px 10px;border-radius:12px;background:rgba(255,255,255,0.08);border:1px solid rgba(0,255,255,0.35);box-shadow:0 0 18px rgba(0,180,255,0.25);backdrop-filter:blur(6px);}.hud-label{font-size:12px;opacity:0.7;}.hud-value{font-size:18px;font-weight:800;text-shadow:0 0 8px rgba(0,255,255,0.7);}#energyWrap{position:fixed;top:60px;left:50%;transform:translateX(-50%);width:70%;height:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.05);overflow:hidden;z-index:10;}#energyBar{height:100%;width:0%;background:linear-gradient(90deg,#0ff,#f0f);box-shadow:0 0 12px rgba(0,255,255,0.8);}#life{color:#ff7;}#countdown{position:fixed;top:40%;left:50%;transform:translate(-50%,-50%);font-size:64px;font-weight:900;color:#fff;text-shadow:0 0 20px #0ff;z-index:20;opacity:0;}#fever{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.6);padding:18px 32px;border-radius:18px;font-size:26px;font-weight:900;color:#ffea6a;background:rgba(255,136,0,0.18);border:1px solid rgba(255,200,0,0.5);text-shadow:0 0 18px rgba(255,190,0,0.9);box-shadow:0 0 24px rgba(255,120,0,0.5);opacity:0;z-index:18;}#summary{position:fixed;top:18%;left:50%;transform:translateX(-50%);padding:16px 20px;border-radius:14px;background:rgba(0,0,0,0.76);border:1px solid rgba(255,255,255,0.2);box-shadow:0 0 28px rgba(0,0,0,0.55);color:#fff;font-size:16px;line-height:1.5;display:none;z-index:25;text-align:center;min-width:260px;}.btn{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);padding:14px 24px;border-radius:16px;border:none;font-size:18px;font-weight:900;letter-spacing:1px;background:linear-gradient(135deg,#22d,#f0f);color:#fff;box-shadow:0 12px 28px rgba(0,0,0,0.45);z-index:20;cursor:pointer;transition:transform 0.1s;}.btn:active{transform:translateX(-50%) scale(0.97);}#retryBtn{display:none;bottom:80px;}#debug{position:fixed;bottom:0;left:0;right:0;height:140px;padding:8px;font-size:12px;overflow:auto;background:rgba(255,0,0,0.12);color:#f44;border-top:1px solid rgba(255,0,0,0.4);display:none;z-index:30;}#tuner{position:fixed;right:10px;top:10px;z-index:12;width:240px;padding:8px;border-radius:12px;background:rgba(0,0,0,0.55);color:#fff;font-size:12px;border:1px solid rgba(255,255,255,0.15);box-shadow:0 0 12px rgba(0,0,0,0.4);}#tuner h4{margin-bottom:6px;color:#0ff;}#tuner label{display:flex;justify-content:space-between;align-items:center;margin:4px 0;}#tuner input{width:130px;}
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div id="hud">
  <div class="hud-item"><div class="hud-label">速度</div><div class="hud-value" id="speed">0</div></div>
  <div class="hud-item"><div class="hud-label">险过连击</div><div class="hud-value" id="near">0</div></div>
  <div class="hud-item"><div class="hud-label">Fever</div><div class="hud-value" id="fevTxt">0%</div></div>
  <div class="hud-item"><div class="hud-label">生命</div><div class="hud-value" id="life">3</div></div>
</div>
<div id="energyWrap"><div id="energyBar"></div></div>
<div id="countdown"></div>
<div id="fever">FEVER 失控</div>
<div id="summary"></div>
<button class="btn" id="startBtn">开 局</button>
<button class="btn" id="retryBtn">再来一局</button>
<div id="tuner">
  <h4>调试参数</h4>
  <label>障碍密度 <input id="t_ob" type="range" min="0.3" max="2.5" step="0.1" value="1"></label>
  <label>车流频率 <input id="t_car" type="range" min="0.4" max="2.0" step="0.1" value="1"></label>
  <label>弯道强度 <input id="t_curve" type="range" min="0" max="1.2" step="0.05" value="0.5"></label>
  <label>难度爬升 <input id="t_diff" type="range" min="0.5" max="2.5" step="0.1" value="1"></label>
  <label>环境切换(s) <input id="t_env" type="range" min="6" max="20" step="1" value="12"></label>
</div>
<div id="debug"></div>

<script>
(function(){
  const dbg=document.getElementById('debug');
  function logErr(msg,url,line,col,err){
    dbg.style.display='block';
    const text=`[${new Date().toLocaleTimeString()}] ${msg} @${line}:${col} ${(err&&err.stack)||''}`;
    dbg.textContent=text+'\n'+dbg.textContent.slice(0,1500);
  }
  window.onerror=(m,u,l,c,e)=>logErr(m,u,l,c,e);
  window.addEventListener('unhandledrejection',e=>logErr(e.reason,'',0,0,e.reason));
})();
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
let w=innerWidth,h=innerHeight; canvas.width=w; canvas.height=h;
addEventListener('resize',()=>{w=innerWidth;h=innerHeight;canvas.width=w;canvas.height=h;});
const hud={speed:document.getElementById('speed'),near:document.getElementById('near'),life:document.getElementById('life'),fevTxt:document.getElementById('fevTxt'),energy:document.getElementById('energyBar')};
const countdownEl=document.getElementById('countdown');
const feverEl=document.getElementById('fever');
const summary=document.getElementById('summary');
const startBtn=document.getElementById('startBtn');
const retryBtn=document.getElementById('retryBtn');
const tuner={
  ob:document.getElementById('t_ob'),
  car:document.getElementById('t_car'),
  curve:document.getElementById('t_curve'),
  diff:document.getElementById('t_diff'),
  env:document.getElementById('t_env')
};
let rngSeed=12345;
function rand(){rngSeed^=rngSeed<<13; rngSeed^=rngSeed>>17; rngSeed^=rngSeed<<5; return ((rngSeed<0?~rngSeed+1:rngSeed)%1000)/1000;}
const AudioCtx=window.AudioContext||window.webkitAudioContext;
let actx=null,engineOsc=null,engineGain=null;
function ensureAudio(){
  if(!actx){actx=new AudioCtx();}
  if(!engineOsc){
    engineOsc=actx.createOscillator();
    engineGain=actx.createGain();
    engineOsc.type='sawtooth';
    engineGain.gain.value=0.001;
    engineOsc.connect(engineGain).connect(actx.destination);
    engineOsc.start();
  }
}
function setEngineFreq(v){
  if(!engineOsc) return;
  const t=actx.currentTime;
  const f=80+v*1.2;
  engineOsc.frequency.exponentialRampToValueAtTime(f,t+0.05);
  engineGain.gain.exponentialRampToValueAtTime(Math.min(0.25,0.05+v/3000),t+0.05);
}
function blip(freq=880,dur=0.1,gain=0.2,type='square'){
  ensureAudio(); const t=actx.currentTime;
  const o=actx.createOscillator(); const g=actx.createGain();
  o.type=type; o.frequency.setValueAtTime(freq,t);
  g.gain.setValueAtTime(gain,t); g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
  o.connect(g).connect(actx.destination); o.start(t); o.stop(t+dur);
}
function boom(intensity=1){
  ensureAudio(); const t=actx.currentTime;
  const b=actx.createBuffer(1,actx.sampleRate*0.35,actx.sampleRate);
  const d=b.getChannelData(0);
  for(let i=0;i<d.length;i++){d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,2.2)*intensity;}
  const s=actx.createBufferSource(); s.buffer=b;
  const g=actx.createGain(); g.gain.value=0.4*intensity;
  const lp=actx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=600+intensity*400;
  s.connect(lp).connect(g).connect(actx.destination); s.start(t);
}
const lanes=5;
const laneWidth=1.1;
let running=false,gameTime=0,last=0,dist=0;
let speed=0,targetSpeed=0;
let accelBase=0.32;
let curveOffset=0;
let lives=3;
let energy=0,fever=false,feverTimer=0,feverCount=0;
let nearCombo=0,nearTimer=0;
let kills=0,nearTotal=0;
let eventsTimer=0;
let environment=0;
const maxSpeed=2200;
const player={x:0,y:0.72,tilt:0,shadow:0};
const objects=[];
const particles=[];
const speedLines=[];
let left=false,right=false;
addEventListener('keydown',e=>{
  if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A') left=true;
  if(e.key==='ArrowRight'||e.key==='d'||e.key==='D') right=true;
});
addEventListener('keyup',e=>{
  if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A') left=false;
  if(e.key==='ArrowRight'||e.key==='d'||e.key==='D') right=false;
});
function project(px,pz){
  const camZ=1.4;
  const f=0.9/(pz+camZ);
  const x=w/2+(px*f*w*0.35);
  const y=h*(0.55+pz*0.08 - f*0.6);
  const s=Math.max(0.1,f*900);
  return {x,y,s};
}
function spawnObject(kind){
  const lane=(Math.floor(rand()*lanes)-Math.floor(lanes/2));
  const z=18+rand()*6;
  const ox=(lane+0.5-rand()*0.2)*laneWidth;
  const baseSpeed=1+rand()*0.2;
  objects.push({
    kind,
    x:ox,
    z,
    vx:0,
    speedMul:baseSpeed,
    alive:true
  });
}
let obTimer=0,carTimer=0;
function procedural(dt){
  const diffScale=parseFloat(tuner.diff.value);
  obTimer-=dt; carTimer-=dt;
  const obFreq=1.4/(parseFloat(tuner.ob.value)*diffScale+0.2);
  const carFreq=1.2/(parseFloat(tuner.car.value)*diffScale+0.1);
  if(obTimer<=0){ spawnObject('obstacle'); obTimer=obFreq*(0.6+rand()*0.6); }
  if(carTimer<=0){ spawnObject('traffic'); carTimer=carFreq*(0.5+rand()*0.7); }
  eventsTimer+=dt;
  if(eventsTimer>10){
    eventsTimer=0;
    const r=rand();
    if(r<0.33){ boostEvent(); }
    else if(r<0.66){ denseTraffic(); }
    else{ hardCurve(); }
  }
}
function boostEvent(){
  targetSpeed+=180;
  addParticles(0,0.4,40,'#7cf');
  screenShake(14);
  blip(1400,0.12,0.3,'sawtooth');
}
function denseTraffic(){
  for(let i=0;i<6;i++){ spawnObject('traffic'); }
}
function hardCurve(){
  curveOffset+=(rand()>0.5?1:-1)*0.8;
  blip(620,0.12,0.2,'triangle');
}
function update(dt){
  gameTime+=dt; dist+=speed*dt*0.05;
  const curveStrength=parseFloat(tuner.curve.value);
  const curve=curveStrength*Math.sin(gameTime*0.4);
  curveOffset+=curve*dt*0.6;
  const input=right-left;
  player.x+=input*dt*6;
  player.x-=curveOffset*dt*1.4;
  player.x=Math.max(-laneWidth*2,Math.min(laneWidth*2,player.x));
  player.tilt=player.tilt*0.9+input*0.18;
  targetSpeed+=accelBase*(1+gameTime*0.035)*dt*110;
  speed=Math.min(maxSpeed*1.15, speed*0.995 + targetSpeed*0.005);
  if(fever){ speed=Math.min(maxSpeed*1.15, speed+dt*260); }
  setEngineFreq(speed);
  ensureLines();
  nearTimer-=dt;
  for(let i=objects.length-1;i>=0;i--){
    const o=objects[i];
    o.z-=dt*speed*0.008*o.speedMul;
    if(fever) o.z-=dt*speed*0.003;
    o.x+=Math.sin(gameTime*0.8+i)*dt*0.2;
    if(o.z<1.5 && o.alive){
      const dx=Math.abs(o.x-player.x);
      if(dx<0.5){
        if(fever && o.kind!=='player'){ hitKill(o,true); continue; }
        crash(o);
      }else if(dx<0.8 && o.z<1){
        near(o);
      }
    }
    if(o.z<-0.5 || !o.alive) objects.splice(i,1);
  }
  if(fever){
    feverTimer-=dt;
    if(feverTimer<=0){ fever=false; energy=0; feverEl.style.opacity=0; }
  }
  if(speed>maxSpeed && lives>0){
    crash(null,true);
  }
}
function crash(o,force=false){
  lives--; hud.life.textContent=lives;
  screenShake(24);
  boom(1.2);
  addParticles(player.x,0.4,80,'#ff6');
  addExplosionFlash();
  speed*=0.7;
  targetSpeed=speed;
  if(lives<=0 || force){
    gameOver();
  }
}
function near(o){
  if(nearTimer>0) nearCombo++; else nearCombo=1;
  nearTimer=1.2;
  nearTotal++;
  energy=Math.min(100,energy+8);
  hud.near.textContent=nearCombo;
  hud.fevTxt.textContent=Math.round(energy)+'%';
  hud.energy.style.width=energy+'%';
  blip(1200- nearCombo*30,0.06,0.18,'square');
  addParticles(o.x,0.45,16,'#0ff');
  if(energy>=100) enterFever();
}
function hitKill(o,fromFever=false){
  o.alive=false; kills++;
  energy=Math.min(100,energy+15);
  hud.fevTxt.textContent=Math.round(energy)+'%';
  hud.energy.style.width=energy+'%';
  addExplosionFlash();
  addParticles(o.x,0.42,42,'#f06');
  screenShake(18);
  boom(1.0);
  if(!fromFever) targetSpeed+=80;
  if(energy>=100) enterFever();
}
function enterFever(){
  fever=true; feverTimer=5; feverCount++; feverEl.style.opacity=1;
  blip(2000,0.18,0.35,'sawtooth');
  addParticles(player.x,0.5,60,'#f0f');
}
function addParticles(px,pz,count,color){
  for(let i=0;i<count;i++){
    particles.push({
      x:px+(rand()-0.5)*0.6,
      z:pz+(rand()-0.5)*0.4,
      vx:(rand()-0.5)*4,
      vz:(rand()-0.5)*2,
      life:0.5+rand()*0.6,
      color,
      size:4+rand()*4
    });
  }
}
function ensureLines(){
  while(speedLines.length<40){
    speedLines.push({x:(rand()-0.5)*3,z:rand()*10+2,len:rand()*0.5+0.2});
  }
}
function screenShake(intensity){
  canvas.style.transform=`translate(${(rand()-0.5)*intensity}px,${(rand()-0.5)*intensity}px)`;
  setTimeout(()=>canvas.style.transform='',80);
}
function addExplosionFlash(){
  ctx.fillStyle='rgba(255,255,255,0.45)';
  ctx.fillRect(0,0,w,h);
  setTimeout(()=>{},50);
}
function render(){
  ctx.clearRect(0,0,w,h);
  drawBackground();
  drawRoad();
  objects.sort((a,b)=>b.z-a.z);
  for(const o of objects){
    const p=project(o.x,o.z);
    const clr=o.kind==='traffic'?'#3df':'#f66';
    ctx.save();
    ctx.translate(p.x,p.y);
    const stretch=1+(speed/1400);
    ctx.scale(p.s*0.008, p.s*0.012*(o.kind==='traffic'?1:0.6));
    ctx.rotate((o.x)*0.08);
    ctx.fillStyle=clr;
    ctx.fillRect(-20,-40*stretch,40,80*stretch);
    ctx.fillStyle='rgba(255,255,255,0.4)';
    ctx.fillRect(-12,-34*stretch,24,30*stretch);
    ctx.restore();
  }
  const pp=project(player.x,0.8);
  ctx.save();
  ctx.translate(pp.x,pp.y);
  ctx.scale(pp.s*0.01,pp.s*0.014);
  ctx.rotate(player.tilt*0.5);
  ctx.fillStyle=fever?'#ff5ee0':'#5ef';
  ctx.fillRect(-22,-60,44,120);
  ctx.fillStyle='rgba(255,255,255,0.5)';
  ctx.fillRect(-14,-46,28,40);
  ctx.restore();
  for(const l of speedLines){
    l.z-=speed*0.014/100;
    if(l.z<0) {l.z=15+rand()*8; l.x=(rand()-0.5)*3;}
    const p1=project(l.x,l.z);
    const p2=project(l.x,l.z+0.4);
    ctx.strokeStyle='rgba(0,255,255,0.2)';
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(p1.x,p1.y);
    ctx.lineTo(p2.x,p2.y);
    ctx.stroke();
  }
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx*0.016; p.z+=p.vz*0.016; p.life-=0.016;
    const pr=project(p.x,p.z);
    ctx.fillStyle=p.color;
    ctx.globalAlpha=Math.max(0,p.life);
    ctx.beginPath(); ctx.arc(pr.x,pr.y,p.size*0.2,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1;
    if(p.life<=0) particles.splice(i,1);
  }
  hud.speed.textContent=Math.round(speed);
  hud.fevTxt.textContent=Math.round(energy)+'%';
  hud.energy.style.width=energy+'%';
}
function drawRoad(){
  const roadW=0.9;
  const horizon=h*0.35;
  const bottomW=w*0.9;
  const topW=w*0.18;
  const cx=w/2+curveOffset*60;
  ctx.fillStyle='rgba(0,0,0,0.6)';
  ctx.fillRect(0,horizon,w,h-horizon);
  ctx.beginPath();
  ctx.moveTo(cx-bottomW/2,h);
  ctx.lineTo(cx+bottomW/2,h);
  ctx.lineTo(cx+topW/2,horizon);
  ctx.lineTo(cx-topW/2,horizon);
  ctx.closePath();
  ctx.fillStyle='#0a0c12';
  ctx.fill();
  ctx.strokeStyle='rgba(255,255,255,0.18)';
  ctx.lineWidth=4;
  for(let i=1;i<lanes;i++){
    const t=i/lanes;
    const x1=cx-bottomW/2+bottomW*t;
    const x2=cx-topW/2+topW*t;
    ctx.setLineDash([18,18]);
    ctx.beginPath();
    ctx.moveTo(x1,h);
    ctx.lineTo(x2,horizon);
    ctx.stroke();
  }
  ctx.setLineDash([]);
  if(eventsTimer>8){
    ctx.fillStyle='rgba(0,180,255,0.18)';
    ctx.fillRect(cx-bottomW*0.2,h*0.7,bottomW*0.4,h*0.08);
  }
}
function drawBackground(){
  const colors=[
    ['#0a0f1d','#061428','#0ef'],
    ['#1a0f10','#260b14','#f06'],
    ['#0f1a15','#0a221f','#0f8']
  ];
  const c=colors[environment%colors.length];
  const g=ctx.createLinearGradient(0,0,0,h);
  g.addColorStop(0,c[0]);
  g.addColorStop(0.6,c[1]);
  g.addColorStop(1,'#010104');
  ctx.fillStyle=g;
  ctx.fillRect(0,0,w,h);
  for(let i=0;i<12;i++){
    const y=((gameTime*40+i*80)%h);
    ctx.fillStyle=i%2?c[2]:'rgba(255,255,255,0.08)';
    ctx.fillRect((i%2?0:w*0.7), y, w*0.3,8);
  }
}
let envTimer=0;
function updateEnvironment(dt){
  envTimer+=dt;
  const envGap=parseFloat(tuner.env.value);
  if(envTimer>envGap){
    envTimer=0; environment++;
    addParticles(-1,0.6,30,'#0ff'); addParticles(1,0.6,30,'#f0f');
  }
}
function startGame(){
  rngSeed=Date.now()%65536;
  running=false; gameTime=0; dist=0; speed=0; targetSpeed=0;
  lives=3; energy=0; fever=false; feverTimer=0; feverCount=0;
  nearCombo=0; nearTotal=0; kills=0;
  objects.length=0; particles.length=0; speedLines.length=0;
  hud.near.textContent='0'; hud.life.textContent='3';
  hud.energy.style.width='0%'; hud.fevTxt.textContent='0%';
  summary.style.display='none'; retryBtn.style.display='none';
  startBtn.style.display='none';
  countdown(3);
}
function countdown(n){
  countdownEl.style.opacity=1;
  countdownEl.textContent=n>0?n:'GO';
  blip(600+200*n,0.12,0.25,'triangle');
  if(n===0){
    setTimeout(()=>{countdownEl.style.opacity=0; running=true; ensureAudio();},500);
    targetSpeed=180;
    accelBase=0.42;
    return;
  }
  setTimeout(()=>countdown(n-1),700);
}
function gameOver(){
  running=false;
  setTimeout(()=>{ showSummary(); },120);
}
function showSummary(){
  summary.style.display='block';
  summary.innerHTML=`<div style="font-size:22px;font-weight:900;margin-bottom:10px;">爆炸失控</div>
  速度：${Math.round(speed)}<br>
  距离：${Math.round(dist)}<br>
  险过：${nearTotal}<br>
  击杀：${kills}<br>
  Fever：${feverCount}`;
  retryBtn.style.display='block';
}
function loop(t){
  const dt=Math.min(0.033,(t-last||0)/1000);
  last=t;
  if(running){ procedural(dt); updateEnvironment(dt); update(dt); }
  render();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
startBtn.onclick=()=>{ startGame(); };
retryBtn.onclick=()=>{ startGame(); };
canvas.addEventListener('pointerdown',()=>ensureAudio());
</script>
</body>
</html>
